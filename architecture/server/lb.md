## DNS 流量调度
一个域名通过 DNS 解析到多个 ip，每个 ip 对应不同的服务端程序实例。这样就完成了流量调度

这种做法有以下不足：
1. 升级不便。比如要想升级 ip1 对应的服务端程序实例，必须先把 ip1 从 DNS 解析中去除，等 ip1 这个实例没有流量了，然后升级该实例，最后把 ip1 加回 DNS 解析中

由于 DNS 解析是有层层缓冲的。把 ip1 从 DNS 解析中去除后，就算我们写明 TTL 是 15 分钟，但是过了一天可能都还有一些用户请求被发送到 ip1 这个实例

2. 流量调度不均衡。DNS 服务器是有能力做一定的流量均衡的，但是域名解析均衡，并不代表真正的流量均衡。一方面，不是每次用户请求都会对应一次 DNS 解析，客户端自己有缓存。另一方面，DNS 解析本身也有层层缓存，到 DNS 服务器的比例已经很少了。在这样情况下，按域名解析做流量调度均衡，是非常粗糙的，实际结果并不可控


## 网络层负载均衡
负载均衡软件 LVS 工作在网络层，LVS 支持三种调度模式

VS/NAT：通过网络地址转换 NAT 技术做调度。请求和响应都会经过调度器中转，性能最差
VS/TUN：把请求报文通过 IP 隧道转发至真实服务器，而真实服务器将响应直接返回给客户，所以调度器只处理请求报文。这种做法性能比 VS/NAT 好很多
VS/DR：通过改写请求报文的 MAC 地址，将请求发送到真实服务器，真实服务器将响应直接返回给客户。这种做法相比 VS/TUN 少了 ip 隧道的开销，性能最好

VS/DR 流程：
客户端 ip 为 cip，mac 为 cmac
1. 客户端发起请求，源 ip 为 cip ，目标 ip 是 vip；源 mac 地址为 cmac ，目标 mac 地址为 dmac
2. 请求包到达 LVS 调度器（Director Server）。保持源 ip 和目标 ip 不变，仅修改目标 mac 地址为 rmac，将请求转发到真实的业务服务器实例 RS（Real Server）
3. RS 收到数据包并经过处理，直接响应发送给客户端

这里面的关键技巧，是 vip 绑定在多台机器上，因此叫做虚拟 ip。它既绑定在 LVS 调度器上，也绑定在所有的业务服务器实例 RS 上。ARP 广播查询 vip 对应的 mac 地址得到 LVS 调度器。在真实的业务服务器实例 RS 上，把 vip 绑定在 lo 接口上，并对 ARP 请求作了抑制，这样就避免 ip 冲突

LVS 负载均衡，相比其他负载均衡技术来说，通用性强、性能优势高。但也有缺点：假如某个业务服务器实例 RS 挂掉，但 LVS 调度器还没有感知到，在这个短周期内转发到该实例的请求都会失败。这样的失败只能依赖客户端重试来解决


## 应用层负载均衡
应用层负载均衡有时候也叫做应用网关，HTTP 协议是应用最为广泛的应用层协议

HTTP 网关收到一个 HTTP 请求后，根据一定调度算法把请求转发给后端真实的业务服务器实例 RS，收到 RS 的应答后，再把它转发给客户端。在发现某个 RS 实例挂了后，HTTP 网关可以将同一个 HTTP 请求重新发给其他 RS 实例


## 优雅升级
对于前端是 LVS 这种网络层负载均衡的场景，升级步骤为：
1. 升级系统通知 LVS 调度器下线要升级的业务服务器实例
2. LVS 调度器将该实例从 RS 集合中去除，这样就不再调度新流量到它。升级系统通知要升级的 RS 实例退出
3. 要升级的 RS 实例处理完所有处理中的请求，然后主动退出。升级系统更新 RS 实例到新版本，并重启
4. 升级系统将 RS 实例重新加回 RS 集合参与调度

对于前端是 HTTP 应用网关这种负载均衡的场景，升级步骤为：
1. 升级系统通知升级的业务服务器实例退出
2. 要升级的 RS 实例进入退出状态，这时新请求进来直接拒绝；处理完所有处理中的请求后，RS 实例主动退出
3. 升级系统更新 RS 实例到新版本，并重启
