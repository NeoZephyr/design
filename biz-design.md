## 积分系统
### 分析
两大功能点，一个是赚取积分，另一个是消费积分。赚取积分功能包括积分赚取渠道，比如下订单、每日签到、评论等；还包括积分兑换规则，比如订单金额与积分的兑换比例，每日签到赠送多少积分等。消费积分功能包括积分消费渠道，比如抵扣订单金额、兑换优惠券、积分换购、参与活动扣积分等；还包括积分兑换规则

### 系统设计
#### 将功能划分到不同模块
有下面三种模块划分方法：
1. 积分赚取渠道及兑换规则、消费渠道及兑换规则的管理和维护不划分到积分系统中，而是放到更上层的营销系统中。比如：下单之后，订单系统通过异步发送消息或者同步调用接口的方式，告知营销系统订单交易成功。营销系统根据拿到的订单信息，查询订单对应的积分兑换规则，计算得到订单可兑换的积分数量，然后调用积分系统的接口给用户增加积分

2. 积分赚取渠道及兑换规则、消费渠道及兑换规则的管理和维护，分散在各个相关业务系统中，比如订单系统、评论系统、签到系统、换购商城、优惠券系统等。比如：下单之后，订单系统根据商品对应的积分兑换比例，计算所能兑换的积分数量，然后直接调用积分系统给用户增加积分

3. 所有的功能都划分到积分系统中，包括积分赚取渠道及兑换规则、消费渠道及兑换规则的管理和维护。比如：下单之后，订单系统告知积分系统订单交易成功，积分系统根据订单信息查询积分兑换规则，给用户增加积分

根据是否符合高内聚、低耦合特性来判断模块划分是否合理。为了避免业务知识的耦合，让下层系统更加通用，我们不希望下层系统包含太多上层系统的业务信息，但可以接受上层系统包含下层系统的业务信息。比如，订单系统、优惠券系统、换购商城等作为调用积分系统的上层系统，可以包含一些积分相关的业务信息。但是积分系统中最好不要包含太多跟订单、优惠券、换购等相关的信息。因此，我们更倾向于第一种和第二种模块划分方式

#### 设计模块之间的交互关系
常见的系统之间的交互方式有两种：一种是同步接口调用，另一种是利用消息中间件异
步调用。第一种方式简单直接，第二种方式的解耦效果更好

#### 设计模块的接口、数据库、业务模型
1. 数据库设计
积分明细表：
id: 明细 id
channel_id: 赚取或者消费渠道 id
event_id: 相关事件 id（订单 id，评论 id，优惠券换购交易 id）
credit: 积分
create_time: 积分赚取或消费时间
expired_time: 积分过期时间

2. 接口设计
兼顾易用性和性能，借鉴 facade 设计模式，在职责单一的细粒度接口之上，再封装一层粗粒度的接口给外部使用

赚取积分
参数：customerId, channelId, eventId, credit, expiredTime
返回：积分明细 id

消费积分
参数：customerId, channelId, eventId, credit, expiredTime
返回：积分明细 id

查询积分
参数：customerId
返回：总可用积分

查询总积分明细
参数：customerId + 分页参数
返回：明细表所有字段信息

查询赚取积分明细
参数：customerId + 分页参数
返回：明细表所有字段信息

查询消费积分明细
参数：customerId + 分页参数
返回：明细表所有字段信息

3. 业务模型设计