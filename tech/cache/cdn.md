## 如何让用户的请求到达 CDN 节点

将第三方厂商提供的 CDN 服务的 IP 隐藏起来，给到用户的最好是一个本公司域名的子域名

域名解析的结果一般有两种，一种叫做 A 记录，返回的是域名对应的 IP 地址；另一种是 CNAME 记录，返回的是另一个域名，也就是说当前域名的解析要跳转到另一个域名的解析上

我们正是利用 CNAME 记录来解决域名映射问题的。比如公司的一级域名叫做 example.com，可以给图片服务的域名定义为 img.example.com，然后将这个域名的解析结果的 CNAME 配置到 CDN 提供的域名上，比如 uclound 可能会提供一个域名是 80f21f91.cdn.ucloud.com.cn

用户在请求图片地址 `http://img.example.com/1.jpg` 时，DNS 服务器会将域名解析到 80f21f91.cdn.ucloud.com.cn 域名上，然后再将这个域名解析为 CDN 的节点 IP，这样就可以得到 CDN 上面的资源数据

不过，因为域名解析过程是分级的，每一级有专门的域名服务器承担解析的职责，所以，域名的解析过程有可能需要跨越公网做多次 DNS 查询，在性能上是比较差的


DNS 分为很多种，有根 DNS，顶级 DNS 等。除此之外还有两种 DNS 需要特别留意：一种是 Local DNS，它是由你的运营商提供的 DNS，一般域名解析的第一站会到这里；另一种是权威 DNS，它的含义是自身数据库中存储了这个域名对应关系的 DNS

域名解析的过程:
1. 域名解析请求先会检查本机的 hosts 文件，查看是否有 www.baidu.com 对应的 IP
2. 如果没有，就请求 Local DNS 是否有域名解析结果的缓存，如果有就返回，标识是从非权威 DNS 返回的结果
3. 如果没有，就开始 DNS 的迭代查询。先请求根 DNS，根 DNS 返回顶级 DNS 的地址
4. 再请求 .com 顶级 DNS，得到 baidu.com 的域名服务器地址
5. 再从 baidu.com 的域名服务器中查询到 www.baidu.com 对应的 IP 地址，返回这个 IP 地址 的同时，标记这个结果是来自于权威 DNS 的结果，同时写入 Local DNS 的解析结果缓存

经过了向多个 DNS 服务器做查询之后，整个 DNS 的解析的时间有可能会到秒级别。这个性能问题有以下解决方案：

在 APP 启动时，对需要解析的域名做预先解析，然后把解析的结果缓存到本地的一个 LRU 缓存里面。这样当我们要使用这个域名的时候，只需要从缓存中直接拿到所需要的 IP 地址就好了，如果缓存中不存在才会走整个 DNS 查询的过程

同时，为了避免 DNS 解析结果的变更造成缓存内数据失效，可以启动一个定时器，定期地更新缓存中的数据


## 如何找到离用户最近的 CDN 节点
GSLB（Global Server Load Balance，全局负载均衡），对于部署在不同地域的服务器之间做负载均衡。它有两方面的作用：
1. 让流量平均分配，使得下面管理的服务器的负载更平均
2. 保证流量流经的服务器与流量源头在地缘上是比较接近的

GSLB 可以通过多种策略，来保证返回的 CDN 节点和用户尽量保证在同一地缘区域，比如说：
1. 可以将用户的 IP 地址按照地理位置划分为若干的区域，然后将 CDN 节点对应到一个区域上，然后根据用户所在区域来返回合适的节点
2. 也可以通过发送数据包测量 RTT 的方式来决定返回哪一个节点


是否能够从 CDN 节点上获取到资源还取决于 CDN 的同步延时。我们一般会通过 CDN 厂商的接口将静态的资源写入到某一个 CDN 节点上，再由 CDN 内部的同步机制将资源分散同步到每个 CDN 节点，即使 CDN 内部网络经过了优化，这个同步的过程是有延时的，一旦我们无法从选定的 CDN 节点上获取到数据，就不得不从源站获取数据，而用户网络到源站的网络可能会跨越多个主干网，这样不仅性能上有损耗，也会消耗源站的带宽，带来更高的研发成本。所以，在使用 CDN 的时候需要关注 CDN 的命中率和源站的带宽情况

