## 幂等处理正常流程
1. 调用方发送请求并被实现方接收
2. 执行接口对应的业务逻辑
3. 执行结果返回给调用方

正常情况下，幂等号随着请求传递到接口实现方之后，接口实现方将幂等号解析出来，传递给幂等框架。幂等框架先去数据库中查找这个幂等号是否已经存在。如果存在，说明业务逻辑已经或者正在执行，就不要重复执行了。如果幂等号不存在，就将幂等号存储在数据库中，然后再执行相应的业务逻辑


## 异常流程
1. 第一个阶段出现异常，比如发送请求失败或者超时，幂等号还没有记录下来，重试请求会被执行，符合我们的预期
2. 第三个阶段出现异常，业务逻辑执行完成了，只是在发送结果给调用方的时候，失败或者超时了，这个时候，幂等号已经记录下来，重试请求不会被执行，也符合我们的预期
3. 第二个阶段出现异常，有三种可能，分别是业务代码异常、业务系统宕机、幂等框架异常


## 业务代码异常处理
遇到业务异常（比如 UserNotExisting 异常），不删除已经记录的幂等号，不允许重新执行同样的业务逻辑，因为再次重新执行也是徒劳的，还是会报告异常

相反，遇到系统异常（比如数据库访问异常），删除已经记录的幂等号，允许重新执行这段业务逻辑。因为在系统级问题修复之后，重新执行之前失败的业务逻辑，就有可能会成功

实际上，为了让幂等框架尽可能的灵活，低侵入业务逻辑，发生异常，是否允许再重试执行业务逻辑，交给业务工程师来决定是最合适的，毕竟他最清楚针对每个异常该如何处理。而幂等框架本身只需要提供删除幂等号的接口，而不需要参与这个决定


## 业务系统宕机处理
如果希望幂等号的记录和业务的执行完全一致，就需要把它们放到一个事务中。执行成功，必然会记录幂等号；执行失败，幂等号记录也会被自动回滚。因为幂等框架和业务系统各自使用独立的数据库来记录数据，所以，需要引入分布式事务，这导致幂等框架的开发难度提高了很多，并且框架使用起来也复杂了很多，性能也会有所损失

针对这个问题，有另外一种解决方案：在存储业务数据的业务数据库中，建一张表来记录幂等号。幂等号先存储到业务数据库中，然后再同步给幂等框架的 Redis 数据库。不过，这个解决方案会导致幂等逻辑，跟业务逻辑没有完全解耦

在工程中，对于这种极少发生的异常，能够做到在出错时能及时发现问题、能够根据记录的信息人工修复就可以了。所以，建议业务系统记录 SQL 的执行日志，在日志中附加上幂等号。这样我们就能在机器宕机时，根据日志来判断业务执行情况和幂等号的记录是否一致


## 幂等框架异常处理
在幂等逻辑执行异常时，选择让接口请求也失败，相应的业务逻辑就不会被重复执行了。毕竟接口请求失败（比如转钱没转成功），比业务执行出错（比如多转了钱），修复的成本要低很多


