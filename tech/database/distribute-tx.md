## XA 协议
DTP 模型:
AP 是应用程序，是事务发起和结束的地方
RM 是资源管理器，主要负责管理每个数据库的连接数据源
TM 是事务管理器，负责事务的全局管理，包括事务的生命周期管理和资源的分配协调等


## 二阶提交
XA 规范实现的分布式事务属于二阶提交事务

在第一阶段，应用程序向事务管理器发起事务请求，而事务管理器则会分别向参与的各个资源管理器发送事务预处理请求，此时这些资源管理器会打开本地数据库事务，然后开始执行数据库事务，但执行完成后并不会立刻提交事务，而是向事务管理器返回已就绪或未就绪状态。如果各个参与节点都返回状态了，就会进入第二阶段

到了第二阶段，如果资源管理器返回的都是就绪状态，事务管理器则会向各个资源管理器发送提交通知，资源管理器则会完成本地数据库的事务提交，最终返回提交结果给事务管理器；如果任意资源管理器返回了未就绪状态，此时事务管理器会向所有资源管理器发送事务回滚通知，此时各个资源管理器就会回滚本地数据库事务，释放资源，并返回结果通知

二阶事务提交存在一些缺陷：
1. 在整个流程中，各个资源管理器节点存在阻塞，只有当所有的节点都准备完成之后，事务管理器才会发出进行全局事务提交的通知，这个过程如果很长，则会有很多节点长时间占用资源，从而影响整个节点的性能

一旦资源管理器挂了，就会出现一直阻塞等待的情况。类似问题，可以通过设置事务超时时间来解决

2. 仍然存在数据不一致的可能性，例如，在最后通知提交全局事务时，由于网络故障，部分节点有可能收不到通知，由于这部分节点没有提交事务，就会导致数据不一致的情况出现


## 三阶事务
3PC 把 2PC 的准备阶段分为了准备阶段和预处理阶段

在第一阶段，只是询问各个资源节点是否可以执行事务
在第二阶段，所有的节点反馈可以执行事务，才开始执行事务操作
在第三阶段，执行提交或回滚操作。并且在事务管理器和资源管理器中都引入了超时机制，如果资源节点一直无法收到来自资源管理器的提交或回滚请求，它就会在超时之后，继续提交事务

3PC 可以通过超时机制，避免管理器挂掉所造成的长时间阻塞问题，但这样还是无法解决在最后提交全局事务时，由于网络故障无法通知到一些节点的问题，特别是回滚通知，这样会导致事务等待超时从而默认提交


## 事务补偿机制
TCC 分为三个阶段

Try 阶段：主要尝试执行业务，执行各个服务中的 Try 方法，主要包括预留操作

Confirm 阶段：确认 Try 中的各个方法执行成功，然后通过 TM 调用各个服务的 Confirm 方法，这个阶段是提交阶段

Cancel 阶段：当在 Try 阶段发现其中一个 Try 方法失败，例如预留资源失败、代码异常等，则会触发 TM 调用各个服务的 Cancel 方法，对全局事务进行回滚，取消执行业务

如果在 Confirm 和 Cancel 阶段出现异常情况，TCC 会不停地重试调用失败的 Confirm 或 Cancel 方法，直到成功为止

TCC 补偿性事务对业务的侵入性非常大：

首先，需要在业务设计的时候考虑预留资源
然后，需要编写大量业务性代码，例如 Try、Confirm、Cancel 方法
最后，还需要为每个方法考虑幂等性。这种事务的实现和维护成本非常高


